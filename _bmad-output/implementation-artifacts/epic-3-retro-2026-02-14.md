# Epic 3 回顾总结 — 代码获取与AI审查上下文组装

**日期**: 2026-02-14
**Epic**: Epic 3 - Code Fetching & AI Review Context Assembly
**状态**: 完成 (3/3 stories done)

---

## 一、Epic 3 交付总结

### 交付指标

| 指标 | 数值 |
|------|------|
| Story完成 | 3/3 (100%) |
| 新增测试 | ~146 (55 + 57 + 34) |
| 测试总数 | 334 (从298增长12%) |
| Adversarial代码审查 | 3次 (每个Story一次) |
| 发现问题 | 12个 (4 HIGH + 8 MEDIUM) |
| HIGH/MEDIUM全部修复 | 12/12 |
| 生产事故 | 0 |
| 新增技术债 | 0 |

### 业务成果

- Diff元数据提取（文件路径、变更类型、语言检测、行统计）
- 双平台Git API客户端（GitHub + GitLab，AWS stub）
- AI审查上下文组装（聚合token预算、优先级截断、降级模式）
- Flyway V7迁移（code_context TEXT列）

### Story概览

| Story | 标题 | 新增测试 | 代码审查问题 |
|-------|------|---------|-------------|
| 3.1 | Diff元数据提取与变更分析 | 55 | 1 HIGH + 2 MEDIUM (全修复) |
| 3.2 | Git平台API客户端 | 57 | 1 HIGH + 3 MEDIUM (全修复) |
| 3.3 | AI审查上下文组装服务 | 34 | 2 HIGH + 3 MEDIUM (全修复) |

---

## 二、成功与亮点

### 1. AI-First设计理念成功验证
Epic 2回顾时发现AI天然理解diff格式，于是将Epic 3从5个Story重新设计为3个（commit d77d864）。去掉了JavaParser AST分析和复杂的hunk解析。事实证明这个决策完全正确——3个Story就交付了完整的上下文组装能力。

### 2. 架构模式高度复用
- **Factory模式**: GitPlatformClientFactory 复用了 WebhookVerificationChain 的List注入模式
- **HttpClient Bean**: 统一的HttpClient配置，可测试的依赖注入
- **Retry模式**: Git API客户端复用了Story 2.7的指数退避思路
- **DTO在common模块**: CodeContext, FileInfo, TaskMetadata 跨模块共享

### 3. Adversarial代码审查持续有效
3次审查发现12个真实问题，包括：
- **聚合token预算缺失** (Story 3.3 H1): rawDiff和文件限制独立管理→改为聚合预算
- **文件排序依据错误** (Story 3.3 H2): ChangeType排序→改为linesAdded+linesDeleted排序
- **GitHub filePath未URL编码** (Story 3.2 H1): 路径含特殊字符时API调用失败
- **Binary文件缺少路径提取** (Story 3.1 H1): Binary diff无---/+++行导致null路径

### 4. Epic 2准备任务100%执行
| 准备任务 | 状态 |
|---------|------|
| 更新Epic 3规划：采用AI驱动混合方案 | 完成 (commit d77d864) |
| 研究GitHub/GitLab REST API | 完成 (Story 3.2实现) |
| 评估AI上下文窗口限制 | 完成 (Story 3.3 token管理) |

---

## 三、挑战与教训

### 1. URL编码/边界条件是反复出现的盲点
Story 3.2的GitHub filePath和GitLab branch都遗漏了URL编码。Story 3.3的TRUNCATION_MARKER在极小token限制下溢出。
- **改进**: 代码审查时重点关注编码处理和边界条件

### 2. 资源预算需要聚合思维
Story 3.3最初rawDiff和文件token限制独立管理，导致总token可能超出上下文窗口。
- **改进**: 设计资源预算时必须考虑聚合限制，预留安全余量

### 3. Maven多模块构建顺序
Story 3.3遇到 `NoClassDefFoundError`——common模块需要先 `mvn install`，否则integration模块找不到类。
- **改进**: 开发时注意模块依赖顺序，新增跨模块引用时先install被依赖模块

### 4. Regex在String.split()中的行为
Story 3.1的 `(?=^diff --git )` regex在 `String.split()` 中不支持多行模式。
- **改进**: 避免在split中使用复杂regex，改用逐行迭代

---

## 四、关键技术模式（Epic 3新增）

| 模式 | 来源 | 复用范围 |
|------|------|---------|
| AI-First Diff处理（元数据提取 + raw Diff直传AI） | Story 3.1 | Epic 4 AI审查 |
| GitPlatformClient Factory + 多平台支持 | Story 3.2 | 文件获取 |
| GitLab JSON→Unified Diff组装 | Story 3.2 | GitLab平台兼容 |
| 聚合Token预算（rawDiff优先 + 剩余分配文件） | Story 3.3 | AI上下文管理 |
| 安全截断（marker溢出时硬截断） | Story 3.3 | 文本处理通用模式 |
| CodeContext DTO（AI消费格式） | Story 3.3 | Epic 4核心输入 |

---

## 五、Epic 2 行动项跟踪

| 行动项 | 状态 | 说明 |
|--------|------|------|
| 创建共享TestFixtureFactory | 未执行 | Epic 3无新集成测试场景需要 |
| ObjectMapper统一为Spring Bean | 间接遵守 | Epic 3无新ObjectMapper实例 |
| AWS CodeCommit完整签名验证 | 未执行 (预期内) | LOW优先级 |
| RedisQueueService迁移到worker | 未执行 | MEDIUM，继续跟踪 |

---

## 六、重大发现 — Epic 4规划需要更新

### 发现内容
基于Epic 3的经验和团队讨论，确定了Epic 4的两个关键架构决策，导致原规划需要调整。

### 技术决策

| 决策 | 选项 | 理由 |
|------|------|------|
| AI HTTP客户端 | 原生HttpClient | 一致性、无新依赖、复用Story 3.2模式 |
| 六维度执行策略 | 单次调用（非并发6次） | 低成本、实现简单、AI模型能力足够 |
| Story 4.2+4.4合并 | OpenAI兼容统一实现 | 只有baseUrl差异，无需两个Story |

### Epic 4 Story重构（5→4）

| 新Story | 内容 | 对应原Story |
|---------|------|------------|
| 4.1 | AI提供商抽象层 + ReviewResult模型 | 原4.1 |
| 4.2 | OpenAI兼容提供商（覆盖OpenAI + Custom endpoint） | 原4.2 + 4.4合并 |
| 4.3 | Anthropic Claude提供商 | 原4.3 |
| 4.4 | 审查编排 + Prompt管理 + 降级策略 | 原4.5（大幅简化，移除并发框架） |

### 移除的组件（不再需要）
- CompletableFuture并发执行框架
- Semaphore(max=3)限流
- ExecutorService(6线程)
- Per-dimension超时和独立降级
- 独立维度失败隔离

### 决策
**Epic更新必要: YES** — 需要更新epics.md和sprint-status.yaml中的Epic 4定义。

---

## 七、行动项

### 从Epic 3学到的教训

| # | 行动项 | 负责人 | 说明 |
|---|--------|--------|------|
| 1 | URL编码/边界条件列入代码审查checklist | Charlie (Senior Dev) | 连续两个Story出现编码遗漏 |
| 2 | 资源预算设计时必须考虑聚合限制 | Charlie (Senior Dev) | Epic 4 token管理预留20%安全余量 |

### 技术债（从Epic 2继续跟踪）

| # | 项目 | 优先级 | 说明 |
|---|------|--------|------|
| 1 | 创建共享TestFixtureFactory | MEDIUM | 可在Epic 4第一个Story中顺带实现 |
| 2 | RedisQueueService迁移到worker模块 | MEDIUM | 等Worker模块启用时处理 |
| 3 | ObjectMapper统一为Spring Bean | MEDIUM | Epic 4新增AI响应解析时统一处理 |

### 团队约定（延续+新增）

- 每个Story的adversarial代码审查继续保持
- 代码审查时重点关注URL编码和边界条件
- 新增ObjectMapper时必须复用Spring Bean
- AI API token预算预留20%安全余量

---

## 八、Epic 4 准备任务

### 关键路径（必须在Epic 4开工前完成）

- [ ] **更新epics.md中Epic 4规划**: 5→4 Story重构，单次调用架构，合并4.2+4.4
- [ ] **更新sprint-status.yaml**: Epic 3→done，调整Epic 4 Story条目

### 并行准备（可在Epic 4进行中完成）

- [ ] 研究OpenAI Chat Completions API格式（请求/响应JSON结构，token计数）
- [ ] 研究Anthropic Messages API格式（与OpenAI的差异点）
- [ ] 设计六维度审查Prompt模板（输出结构化JSON的Prompt工程）

### 现有基础设施复用

| 组件 | 来源 | Epic 4用途 |
|------|------|-----------|
| HttpClient Bean + retry模式 | Story 3.2 | AI API HTTP调用 |
| Factory模式 | Story 3.2 | AIProviderFactory |
| AIModelConfig 实体/API | Story 1.6 | 加载AI模型配置 |
| PromptTemplate 实体/API | Story 1.7 | 加载审查Prompt模板 |
| CodeContext DTO | Story 3.3 | AI审查输入 |
| 指数退避 + 抖动 | Story 2.7 | AI API重试 |
| ReviewTask 生命周期 | Story 2.5 | 任务状态管理 |

### 潜在风险

| 风险 | 缓解措施 |
|------|---------|
| AI返回非法JSON | 重试 + JSON修复尝试 + 降级 |
| Token计数不准确 | 预留20%余量 |
| Rate Limiting | 单元测试全Mock，集成测试限频 |

---

## 九、参与人员

| 角色 | 名称 |
|------|------|
| Project Lead | ethan |
| Scrum Master (主持) | Bob |
| Product Owner | Alice |
| Senior Developer | Charlie |
| QA Engineer | Dana |
| Junior Developer | Elena |

---

## 十、总结

Epic 3成功交付了完整的代码获取与AI审查上下文组装能力：Diff元数据提取、双平台Git API客户端、AI友好的上下文组装服务。3个Story全部完成，146个新测试（总计334），3次adversarial代码审查发现并修复了12个真实问题。

最重要的成果是**验证了AI-First设计理念**——从Epic 2回顾中提出的假设，到Epic 3的成功精简实施（5→3 Story），证明了利用AI原生能力替代复杂工程化方案的可行性。

基于Epic 3的经验，团队为Epic 4做出了关键架构决策：原生HttpClient、单次调用覆盖六维度、Story 4.2+4.4合并。Epic 4从5个Story精简为4个，移除了不必要的并发框架。

**Epic 3: DONE**
