# Epic 1 回顾: 项目基础设施与配置管理

**日期:** 2026-02-10
**主持:** Bob (Scrum Master)
**参与:** Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), ethan (Project Lead)

---

## Epic 1 交付概要

| 指标 | 数值 |
|------|------|
| Stories 完成 | 9/9 (100%) |
| 最终测试数 | 89 (25 common + 14 repository + 50 API) |
| 对抗性代码审查 | 5 次 (Stories 1.2, 1.5, 1.6, 1.7, 1.8, 1.9) |
| 审查发现问题 | 43 个 (37 已修复, 6 LOW 延迟) |
| 新建源文件 | ~60 个 (Java/Config/Docker/Monitoring) |
| Docker 服务 | 6 个 (postgres, redis, backend, frontend, prometheus, grafana) |
| Flyway 迁移 | 4 个版本 (V1~V4) |
| 开发模型 | Sonnet 4.5 (1.1-1.5) → Opus 4.6 (1.6-1.9) |

**业务成果:**
- ✅ Spring Boot 6 模块 + Vue-Vben-Admin 前端完整初始化
- ✅ PostgreSQL + Redis + Docker Compose 基础设施
- ✅ 三套 CRUD API (Project / AI Model / Prompt Template) + AES-256-GCM 加密
- ✅ Prometheus + Grafana 监控栈 + 3 条告警规则
- ✅ 请求追踪 (X-Request-Id / MDC Correlation)

---

## 做得好的 (What Went Well)

### 1. CRUD 模式复制效率极高
Story 1.5 建立的 Controller → Service → Repository → Entity + DTO 模式成为黄金模板。Story 1.6 首次运行零错误，Story 1.7 仅一个 HandlebarsException 需要调试。模式复制使后续 API 开发效率提升 3 倍以上。

### 2. 对抗性代码审查发现真实问题
5 次审查共发现 43 个问题，包括：
- SSRF 漏洞 (Story 1.6 testConnection)
- 数据库连接泄漏 (Story 1.6 @Transactional 在 HTTP 调用中)
- Grafana 数据源 UID 不匹配 (Story 1.9)
- Docker 凭据硬编码 (Story 1.8)

### 3. Docker-First 策略一致执行
从 Story 1.3 开始，所有基础设施服务均通过 Docker 容器运行，确保环境一致性。到 Story 1.8 完成时，整个开发栈可通过 `docker-compose up` 一键启动。

### 4. 测试增长健康
从 Story 1.1 的 4 个测试到 Story 1.9 的 89 个测试，每个 Story 都增加了覆盖率，且无回归。

### 5. 模型升级带来质量提升
Stories 1.6-1.9 使用 Opus 4.6 后，首次运行成功率显著提高，调试时间减少。

---

## 挑战与教训 (Challenges & Lessons)

### 1. `-parameters` 编译器标志未启用 (贯穿全 Epic)
**影响:** SpEL 必须用 `#p0` 而非参数名；`@PathVariable`/`@RequestParam` 必须写明 `value` 属性。
**教训:** 这是项目初始化时应确定的配置，后期修改影响范围大。

### 2. Spring Boot Profile 陷阱 (Story 1.8)
- `spring.profiles.include` 在 profile 文件中被禁止 (2.4+)
- Profile group 成员会覆盖宿主 profile (违反直觉)
- **解决:** Docker profile 完全自包含，不依赖继承

### 3. Redis Instant 序列化 (Story 1.5)
- `java.time.Instant` 默认不被 Jackson 支持
- **解决:** RedisConfig 中注册 `JavaTimeModule`，添加 `jackson-datatype-jsr310` 依赖

### 4. 集成测试 RANDOM_PORT 不回滚 (Story 1.5)
- `@Transactional` 在 `RANDOM_PORT` WebEnvironment 中不回滚
- **解决:** `@BeforeAll` + `repository.deleteAll()` 手动清理

### 5. Spring Boot 3.2.x 测试禁用 Observability (Story 1.9)
- 测试中默认用 `SimpleMeterRegistry` 替代 `PrometheusMeterRegistry`
- **解决:** 添加 `@AutoConfigureObservability` 注解

### 6. Windows Docker 符号链接问题 (Story 1.2/1.8)
- Windows `node_modules` 符号链接在 Linux 容器中失败
- **解决:** `.dockerignore` 使用 `**/node_modules` 和 `**/dist`

### 7. Vben Admin 单仓结构偏差 (Story 1.2)
- AC 假设平面目录结构，实际是 pnpm workspace 单仓
- 包名 `@vben/web-ele` 不可修改
- 默认端口 5666 (非 5173)

---

## 关键技术模式 (Patterns Established)

| 模式 | 来源 | 复用 |
|------|------|------|
| CRUD API (Controller→Service→Repo→DTO) | Story 1.5 | 1.6, 1.7, Epic 2+ |
| AES-256-GCM AttributeConverter 加密 | Story 1.5 | 1.6 |
| `@Cacheable(key="#p0")` + `@CacheEvict` | Story 1.5 | 1.6, 1.7 |
| `@Transactional(NOT_SUPPORTED)` 非 DB 操作 | Story 1.6 | 1.7 |
| DB CHECK 约束防御性校验 | Story 1.6 | 1.7 |
| Docker ${VAR:-default} 环境变量 | Story 1.8 | 1.9 |
| Filter 注册优先级 (HIGHEST_PRECEDENCE) | Story 1.9 | Epic 2+ |
| `@AutoConfigureObservability` 测试注解 | Story 1.9 | 需要 metrics 的测试 |

---

## 遗留技术债务

| 项目 | 来源 | 优先级 | 影响 |
|------|------|--------|------|
| `-parameters` 编译器标志未启用 | Story 1.1 | LOW | 代码冗余但不影响功能 |
| 5 个未使用的 Vben 应用 (web-antd 等) | Story 1.2 | LOW | 仓库体积偏大 |
| Docker 容器以 root 运行 | Story 1.8 | LOW | 开发环境可接受 |
| 前端 README 启动指南缺失 | Story 1.8 | LOW | 文档缺口 |
| Prometheus scrape_interval 冗余 | Story 1.9 | LOW | 纯装饰性 |
| 测试中 raw Map 类型警告 | Story 1.9 | LOW | 编译器警告 |

**评估:** 所有债务均为 LOW 优先级，不阻塞 Epic 2 开发。

---

## Epic 2 准备评估

### 依赖检查
| Epic 1 组件 | Epic 2 需要 | 状态 |
|---|---|---|
| Project 表 + ProjectRepository | Webhook 查询项目配置 | ✅ 就绪 |
| webhook_secret + AES 解密 | HMAC 签名验证 | ✅ 就绪 |
| Redis 连接 + Lettuce | 优先级队列 (Sorted Set) | ✅ 就绪 |
| Docker Compose 环境 | 集成测试基础设施 | ✅ 就绪 |
| 监控栈 (Prometheus/Grafana) | 任务队列监控 | ✅ 就绪 |
| CRUD API 模式 | Webhook Controller 模式参考 | ✅ 就绪 |

### 新技术需求 (Epic 2 特有)
- 责任链模式 (WebhookVerificationChain)
- HMAC-SHA256 签名验证
- AWS Signature V4 验证
- Redis Sorted Set 优先级队列
- 分布式锁 (防重复处理)
- 指数退避重试 + 随机抖动

### 就绪判定
**Epic 2 就绪: ✅ YES** — 所有依赖满足，无阻塞项，可直接开始 Story 2.1。

---

## Action Items

| # | Action | Owner | 状态 |
|---|--------|-------|------|
| 1 | 更新 epic-1 状态为 done | Bob (SM) | ✅ 本次完成 |
| 2 | 记录 MEMORY.md 关键模式 | Dev Agent | ✅ 已记录 |
| 3 | 开始 Epic 2 Story 创建 | Bob (SM) | 待执行 |

---

## 总结

Epic 1 成功交付了完整的项目基础设施：6 模块后端 + Vue 前端 + PostgreSQL + Redis + 3 套 CRUD API + Docker 环境 + 监控栈。89 个测试提供质量保障，5 次对抗性代码审查修复了 37 个问题。建立的 CRUD 模式、加密模式、Docker 模式将直接服务于后续 Epic。

团队从 Epic 1 积累了丰富的 Spring Boot 3.2.x 实践经验，特别是 Profile 管理、Redis 序列化、测试隔离和 Docker 集成方面。这些经验已记录在 MEMORY.md 和 patterns.md 中，确保后续 Epic 不重蹈覆辙。

**Epic 1: DONE ✅**
