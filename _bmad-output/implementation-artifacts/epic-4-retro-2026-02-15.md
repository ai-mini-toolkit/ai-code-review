# Epic 4 回顾总结 — AI 智能审查引擎

**日期**: 2026-02-15
**Epic**: Epic 4 - AI Smart Code Review Engine
**状态**: 完成 (4/4 stories done)

---

## 一、Epic 4 交付总结

### 交付指标

| 指标 | 数值 |
|------|------|
| Story 完成 | 4/4 (100%) |
| 新增测试 | +131 (334 → 465) |
| Adversarial 代码审查 | 4 次 (每个 Story 一次) |
| 发现问题 | 21 个 (6 HIGH + 15 MEDIUM) |
| HIGH/MEDIUM 全部修复 | 21/21 |
| 生产事故 | 0 |
| 新增技术债 | 1 (buildUserMessage 重复，LOW 优先级) |

### 业务成果

- AI 提供商抽象层（Strategy + Factory 模式）
- OpenAI 兼容提供商（Chat Completions API，支持自定义 endpoint）
- Anthropic Claude 提供商（Messages API）
- 审查编排服务（3 级降级策略：Primary → Fallback → Failed）
- Prompt 模板渲染（Handlebars）
- Micrometer 指标监控（duration, success, failure, degradation, provider.used）

### Story 概览

| Story | 标题 | 新增测试 | 代码审查问题 |
|-------|------|---------|-------------|
| 4.1 | AI 提供商抽象层 | 29 | 1H + 3M + 1L (全修复) |
| 4.2 | OpenAI 兼容提供商 | 27 | 1H + 3M + 1L (全修复) |
| 4.3 | Anthropic Claude 提供商 | 35 | 1H + 3M + 1L (全修复) |
| 4.4 | 审查编排与降级策略 | 18 | 1H + 4M + 1L (全修复) |

---

## 二、成功与亮点

### 1. Epic 3 回顾决策完美落地
Epic 3 回顾中做出的三个关键架构决策在 Epic 4 中完全验证：
- **原生 HttpClient**（非 SDK）→ 与 Story 3.2 模式一致，调试透明
- **单次 AI 调用**（非 6 维度并发）→ 实现简单，成本低
- **5→4 Story 精简**（合并 4.2+4.4）→ 按计划交付，无多余工作

### 2. Provider 模式高度可复用
Story 4.2 建立的完整 Provider 实现模式（构造注入、executeWithRetry、错误分类、响应解析）被 Story 4.3 几乎原样复制。只改了 API 差异点：
- 认证头：`Authorization: Bearer` → `x-api-key`
- 系统提示：messages 数组第一个元素 → 顶层 `system` 字段
- 响应解析：`choices[0].message.content` → `content[0].text`

### 3. "代码审查经验传递"模式有效
Story 4.2 的代码审查发现的模式（private 方法可见性、ERROR 日志在 throw 前、sorted output 保证确定性）被 4.3 和 4.4 从一开始就主动应用。审查效率逐 Story 提升。

### 4. Adversarial 代码审查持续发现真实问题
4 次审查发现 21 个真实问题，包括：
- **Metrics 双重计数** (Story 4.4 H1): `reviewFailureCounter` 在两处 increment
- **Duplicate provider ID 未处理** (Story 4.1 H1): AIProviderFactory 需要 merge function
- **ERROR 日志缺失** (Story 4.2 H1): `executeWithRetry` 最终失败未记录 ERROR
- **Timeout 状态码未测试** (Story 4.3 H1): 408/504 HTTP 状态码缺少测试

---

## 三、挑战与教训

### 1. 枚举值名称不匹配（3 次重复出现）
Story 4.2: `ChangeType.MODIFIED` → 实际是 `MODIFY`
Story 4.3: `IssueCategory.BUG` → 实际是 `CORRECTNESS`
Story 4.3: `FileInfo.language` 误以为是 String → 实际是 `Language` 枚举
- **改进**: Story 文件的 dev notes 应列出所有跨模块引用的枚举确切值

### 2. Maven 多模块构建顺序（老问题）
Story 4.4 遇到 `AIProvider` 类找不到——integration 模块未先 `mvn install`。这个问题从 Epic 3 的 Story 3.3 就出现过。
- **改进**: 新增跨模块引用时，第一步必须 `mvn install` 被依赖模块

### 3. Metrics 逻辑分散导致 bug
Story 4.4 的 `reviewFailureCounter` 在 `executeWithFallback()` 和 `review()` 两处都 increment，导致每次失败计数翻倍。测试用 `isGreaterThanOrEqualTo` 掩盖了这个 bug。
- **改进**: Counter increment 只在一个统一位置；测试断言必须精确（isEqualTo）

### 4. 错误的异常类型语义
Story 4.4 把 Handlebars 模板渲染错误包装为 `AIProviderException`，但模板错误不是 AI 提供商错误。虽然功能不受影响（被 generic catch 捕获），但语义有误导性。
- **改进**: 异常类型必须与错误来源匹配

---

## 四、关键技术模式（Epic 4 新增）

| 模式 | 来源 | 复用范围 |
|------|------|---------|
| AIProvider 策略模式 + AIProviderFactory 工厂 | Story 4.1 | 所有 AI 提供商 |
| ReviewResult / ReviewIssue / ReviewMetadata DTO | Story 4.1 | Epic 5 持久化 |
| AI 异常层级 (AIProviderException → Rate/Auth/Timeout) | Story 4.1 | 错误处理 |
| HttpClient + executeWithRetry + 指数退避 | Story 4.2 | AI API 调用 |
| 结构化用户消息构建 (CodeContext → text) | Story 4.2/4.3 | AI Prompt 输入 |
| 3 级降级策略 (Primary → Fallback → Failed) | Story 4.4 | 高可用 |
| Handlebars 模板渲染 + CodeContext 变量注入 | Story 4.4 | Prompt 管理 |
| Micrometer 指标 (Timer + Counter + tags) | Story 4.4 | 可观测性 |

---

## 五、Epic 3 行动项跟踪

| 行动项 | 状态 | 说明 |
|--------|------|------|
| URL编码/边界条件列入代码审查 checklist | ✅ 完成 | 4.3 审查成功发现 408/504 边界 |
| 资源预算聚合思维 | ✅ 完成 | Token 预算模式从 3.3 延续复用 |
| 创建共享 TestFixtureFactory | ❌ 未执行 | Epic 4 无新集成测试场景需要 |
| RedisQueueService 迁移到 worker | ❌ 未执行 | Worker 模块尚未启用 |
| ObjectMapper 统一为 Spring Bean | ❌ 未执行 | 4.4 仍创建 new ObjectMapper() |

---

## 六、重大发现 — Epic 5 规划需要更新

### 发现内容
Epic 5 的 Story 5.3（调用链路图可视化）和 Story 5.2（报告生成）的部分 AC 依赖调用图分析（CallGraph），但 Epic 3 重新设计时已完全移除 AST 解析和调用链路分析（AI-First 策略）。

### 影响分析

| 受影响 Story | 问题 | 建议 |
|-------------|------|------|
| Story 5.3 | 完全依赖不存在的 CallGraph 数据 | 移除或重新设计 |
| Story 5.2 | 报告中 callGraph 字段无数据来源 | 调整 AC，移除 callGraph 相关内容 |
| Story 5.1 | 表结构中 call_graph JSONB 列 | 移除该列或保留为 null |
| Story 5.4 | 查询 API 不受影响 | 无需调整 |

### 决策
**Epic 更新必要: YES** — 需要在开工前更新 epics.md 中 Epic 5 的定义。

---

## 七、行动项

### 从 Epic 4 学到的教训

| # | 行动项 | 负责人 | 说明 |
|---|--------|--------|------|
| 1 | Story dev notes 列出跨模块枚举确切值 | SM Agent | 避免枚举名称不匹配 |
| 2 | Metrics counter 只在单一位置 increment | Charlie | 避免双重计数 |
| 3 | 测试断言用 isEqualTo 而非 isGreaterThanOrEqualTo | Dana | 精确验证不掩盖 bug |

### 技术债（从 Epic 2/3 继续跟踪）

| # | 项目 | 优先级 | 说明 |
|---|------|--------|------|
| 1 | buildUserMessage 提取为共享工具方法 | LOW | OpenAI/Anthropic 间重复 |
| 2 | RedisQueueService 迁移到 worker 模块 | MEDIUM | 等 Worker 模块启用 |
| 3 | ObjectMapper 统一管理 | LOW | 当前各处 new 实例 |

### 团队约定（延续+新增）

- 每个 Story 的 adversarial 代码审查继续保持
- 代码审查教训在下一个 Story 主动应用（"经验传递"模式）
- Metrics counter 必须只在单一位置 increment
- 测试断言用精确值 (isEqualTo)，不用范围值
- 新增跨模块依赖时先 mvn install 被依赖模块

---

## 八、Epic 5 准备任务

### 关键路径（必须在 Epic 5 开工前完成）

- [ ] **更新 epics.md 中 Epic 5 规划**: 移除/重新设计 Story 5.3，调整 Story 5.2 AC
- [ ] **更新 sprint-status.yaml**: Epic 4→done，调整 Epic 5 Story 条目
- [ ] **设计 review_result 表结构**: JSONB 列存储 issues + statistics，外键关联 review_task

### 并行准备（可在 Epic 5 进行中完成）

- [ ] 研究 PostgreSQL JSONB 查询模式（按 severity/category 聚合统计）
- [ ] 设计报告生成服务的 Markdown/HTML/JSON 输出格式

### 现有基础设施复用

| 组件 | 来源 | Epic 5 用途 |
|------|------|-----------|
| ReviewResult / ReviewIssue DTO | Story 4.1 | 持久化到 JSONB |
| ReviewMetadata | Story 4.1 | 存储审查元数据 |
| ReviewOrchestrator | Story 4.4 | 审查完成后触发保存 |
| IssueSeverity / IssueCategory 枚举 | Story 4.1 | 统计分析 |
| Flyway 迁移模式 | Story 1.3/2.5 | 新增 review_result 表 |
| CRUD API 模式 | Story 1.5 | 查询 API |

### 潜在风险

| 风险 | 缓解措施 |
|------|---------|
| JSONB 查询性能 | 创建 GIN 索引，测试大数据量查询 |
| ReviewResult DTO 变更 | 使用 JSONB 灵活 schema，向前兼容 |
| 报告格式需求不明确 | 先实现 JSON 格式，Markdown/HTML 后续迭代 |

---

## 九、参与人员

| 角色 | 名称 |
|------|------|
| Project Lead | ethan |
| Scrum Master (主持) | Bob |
| Product Owner | Alice |
| Senior Developer | Charlie |
| QA Engineer | Dana |
| Junior Developer | Elena |

---

## 十、总结

Epic 4 成功交付了完整的 AI 智能审查引擎：AI 提供商抽象层、OpenAI 兼容提供商、Anthropic Claude 提供商、审查编排与降级策略。4 个 Story 全部完成，131 个新测试（总计 465），4 次 adversarial 代码审查发现并修复了 21 个真实问题。

最重要的成果是 **Epic 3 回顾决策的完美验证**——原生 HttpClient、单次调用策略、5→4 Story 精简，全部在 Epic 4 中证明了正确性。"回顾驱动决策"模式已成为项目核心实践。

回顾中发现的 **Epic 5 规划问题**（Story 5.3 依赖不存在的 CallGraph）是本次回顾最重要的产出——在开工前发现问题，避免了无效工作。

**Epic 4: DONE**
